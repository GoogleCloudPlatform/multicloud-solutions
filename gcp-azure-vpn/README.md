# Terraform to build HA VPN connections between Google Cloud and Azure

**Disclaimer**: This interoperability terraform setup is intended to be minimal in
nature with less user input and auto public ip and shared key creation. Customers should verify this by testing it.

## Before you begin
1.  Go through steps to create [GCP to Azure HA VPN setup](https://cloud.google.com/network-connectivity/docs/vpn/tutorials/create-ha-vpn-connections-google-cloud-azure) (gcp cli commands and azure console guide)
1.  Review information about how
    [dynamic routing](https://cloud.google.com/network-connectivity/docs/vpn/concepts/choosing-networks-routing#dynamic-routing)
    works in Google Cloud.

## Assumption

1.  Required Administrative role is assigned to respective user (which will be used to run terraform) on [GCP](https://cloud.google.com/network-connectivity/docs/vpn/tutorials/create-ha-vpn-connections-google-cloud-azure#before-you-begin) and Azure
1.  VPC and subnets is already created at GCP and Azure
1.  GCP firewall rule must be added for traffic flow (ingress and egress) between azure and gcp
1.  Azure security group and route table modification for traffic flow and subnet propagation

## Terraform variables and values

Add below variables in terraform.tfvars according to your setup, see example.tfvars

| variable                        | Description                              | Required | Default        |
| ------------------------------- | ---------------------------------------- | -------- | -------------- |
| gcp_project_id                  | gcp project ID.                          | yes      |                |
| gcp_region                      | gcp region of cloud router and vpn setup | yes      |                |
| gcp_bgp_asn                     | gcp router bgp ASN                       | no       | "64512"        |
| gcp_network                     | gcp VPC network name                     | yes      |                |
| gcp_vpn_shared_secret           | gcp shared secret                        | yes      |                |
| gcp_custom_advertised_ip_ranges | list of gcp advertised ip ranges         | yes      |                |
| azure_network_name              | azure Network Name                       | yes      |                |
| azure_location                  | azure location                           | yes      |                |
| azure_gateway_cidr              | azure gateway CIDR                       | yes      |                |
| azure_gateway_sku               | azure gateway SKU                        | no       | "VpnGw2"       |
| azure_bgp_asn                   | azure bgp asn                            | no       | "65515"        |
| gcp_bgp_apipa_ip_1              | gcp bgp apip ip 1                        | no       | "169.254.21.2" |
| gcp_bgp_apipa_ip_2              | gcp bgp apip ip 2                        | no       | "169.254.22.2" |
| azure_bgp_apipa_ip_1            | azure bgp apip ip 1                      | no       | "169.254.21.1" |
| azure_bgp_apipa_ip_2            | azure bgp apip ip 2                      | no       | "169.254.22.1" |

## High-level configuration steps

Because HA VPN is dependent on BGP IP settings generated by Azure, you must configure Cloud VPN and Azure components in the following sequence:

1. Create an azure active-active VPN gateway
2.  Create Cloud Router and HA VPN gateway.
3.  Create two VPN tunnels and BGP sessions.
4.  Create azure local network gateway and vpn connections

Azure terminology and the Azure logo are trademarks of Moicrosoft Azure or its affiliates in the United States and/or other countries.

## Terminology
Learn how to build site-to-site IPSec VPNs between [HA VPN](https://cloud.google.com/network-connectivity/docs/vpn/) on Google Cloud and Azure.

Below are definitions of terms used throughout this guide.

- **Google Cloud VPC network**: A single virtual network within a single Google Cloud project.
- **On-premises gateway**: The VPN device on the non-Google Cloud side of the
  connection, which is usually a device in a physical data center or in
  another cloud provider's network. Google Cloud instructions are written from the
  point of view of the Google Cloud VPC network, so _on-premises gateway_ refers to the
  gateway that's connecting _to_ Google Cloud.
- **External IP address** or **Google Cloud peer address**: External IP
  addresses used by peer VPN devices to establish HA VPN with Google Cloud.
  External IP addresses are allocated automatically, one for each gateway interface within a
  Google Cloud project.
- **Dynamic routing**: Google Cloud dynamic routing for VPN using the
  [Border Gateway Protocol (BGP)](https://wikipedia.org/wiki/Border_Gateway_Protocol).
  Note that HA VPN only supports dynamic routing.

## Topology

HA VPN supports [multiple topologies](https://cloud.google.com/network-connectivity/docs/vpn/concepts/topologies).

This interop guide is based on the
[One peer VPN device with two IP addresses](https://cloud.google.com/network-connectivity/docs/vpn/concepts/topologies#1-peer-2-addresses) topology
using with `REDUNDANCY_TYPE` of `TWO_IPS_REDUNDANCY`.

There are three major gateway components to set up for this configuration, as shown in the following topology diagram:

- An HA VPN gateway in Google Cloud with two interfaces.
- Azure virtual network gateway, which connect to your HA VPN gateway.
- An external VPN gateway resource in Google Cloud represents your Azure virtual network gateway. This resource provides
  information to Google Cloud about your Azure gateway.

  
The supported Azure configuration uses a total of two tunnels:

- Two tunnels of connection from one Azure local network gateway to one interface of the HA VPN gateway.

![Topology diagram](https://cloud.google.com/static/network-connectivity/docs/vpn/images/ha-vpn-google-cloud-to-azure.svg)