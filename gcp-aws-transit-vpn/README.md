# Terraform to build HA VPN connections between Google Cloud and AWS

**Disclaimer**: This interoperability terraform setup is intended to be minimal in
nature with less user input and auto public ip and shared key creation. Customers should verify this by testing it.

## Before you begin
1.  Go through steps to create [GCP to AWS HA VPN setup](https://cloud.google.com/architecture/build-ha-vpn-connections-google-cloud-aws) (aws and gcp cli commands)
1.  Review information about how
    [dynamic routing](https://cloud.google.com/network-connectivity/docs/vpn/concepts/choosing-networks-routing#dynamic-routing)
    works in Google Cloud.

## Assumption

1.  Required Administrative role is assigned to respective user (which will be used to run terraform) on [GCP](https://cloud.google.com/architecture/build-ha-vpn-connections-google-cloud-aws#before-you-begin) and AWS
1.  VPC and subnets is already created at GCP and AWS
1.  GCP firewall rule must be added for traffic flow (ingress and egress) between aws and gcp
1.  AWS security group and route table modification for traffic flow and subnet propagation

## Terraform variables and values

Modify below variables in terraform.tfvars according to your setup

| variable           | Description                                                                                                                             | Required | Default |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------- | -------- | ------- |
| gcp_project_id     | gcp project ID.                                                                                                                         | yes      |         |
| gcp_region         | gcp region of cloud router and vpn setup                                                                                                | yes      |         |
| gcp_bgp            | gcp router bgp ASN                                                                                                                      | yes      | "65273" |
| gcp_network        | gcp VPC network name                                                                                                                    | yes      |         |
| aws_vpc_id         | aws vpc ID                                                                                                                              | yes      |         |
| aws_region         | aws region                                                                                                                              | yes      |         |
| aws_transit_vpc_sub_ids | aws VPC ID as key and value as list of subnets that will be attached to transit gateway | no       |       |
| aws_route_vpc_transit | aws VPC route table ID as key and value as list of gcp cidr ranges that will be forwarded to transit gateway | no       |       |

## High-level configuration steps

Because HA VPN is dependent on BGP IP settings generated by AWS, you must configure Cloud VPN and AWS components in the following sequence:

1.  Create the HA VPN gateway and create a Cloud Router.
1.  Create Transit gateway.
1.  Create two AWS site-to-site VPN connections and customer gateways.
1.  Create four VPN tunnels on the HA VPN gateway.
1.  Configure BGP sessions on the Cloud Router using the BGP IP addresses and auto shared key.

AWS terminology and the AWS logo are trademarks of Amazon Web Services or its affiliates
in the United States and/or other countries.

## Terminology
Learn how to build site-to-site IPSec VPNs between [HA VPN](https://cloud.google.com/network-connectivity/docs/vpn/) on Google Cloud and AWS.

Below are definitions of terms used throughout this guide.

- **Google Cloud VPC network**: A single virtual network within a single Google Cloud project.
- **On-premises gateway**: The VPN device on the non-Google Cloud side of the
  connection, which is usually a device in a physical data center or in
  another cloud provider's network. Google Cloud instructions are written from the
  point of view of the Google Cloud VPC network, so _on-premises gateway_ refers to the
  gateway that's connecting _to_ Google Cloud.
- **External IP address** or **Google Cloud peer address**: External IP
  addresses used by peer VPN devices to establish HA VPN with Google Cloud.
  External IP addresses are allocated automatically, one for each gateway interface within a
  Google Cloud project.
- **Dynamic routing**: Google Cloud dynamic routing for VPN using the
  [Border Gateway Protocol (BGP)](https://wikipedia.org/wiki/Border_Gateway_Protocol).
  Note that HA VPN only supports dynamic routing.

## Topology

HA VPN supports [multiple topologies](https://cloud.google.com/network-connectivity/docs/vpn/concepts/topologies).

This interop guide is based on the
[AWS-peer-gateways](https://cloud.google.com/vpn/docs/concepts/topologies#aws_peer_gateways) topology
using with `REDUNDANCY_TYPE` of `FOUR_IPS_REDUNDANCY`.

